<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - ÖğrenciKargo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    
</head>
<body>

<!-- Profile Header -->
<header class="profile-header bg-custom-primary">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-3 text-center">
                <img src="assets/images/profile-picture.jpg" alt="Profil Fotoğrafı" class="profile-avatar rounded-circle mb-3">
                <div class="mt-0">
                    <button class="btn btn-light btn-sm">Fotoğrafı Değiştir</button>
                </div>
                
            </div>
            <div class="col-md-9">
                <h1>{{userName}}</h1>
                <div class="d-flex align-items-center gap-4">
                    <span class="badge bg-custom-warning" *ngIf="isVerified">
                        <i class="fas fa-check-circle me-2"></i>Doğrulanmış Öğrenci
                    </span>
                    
                </div>
                
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-dark">
                            <div class="fs-5 fw-bold">₺5,430</div>
                            <small>Toplam Kazanç</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-dark">
                            <div class="fs-5 fw-bold">87</div>
                            <small>Tamamlanan İş</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white rounded p-3 text-dark">
                            <div class="fs-5 fw-bold">{{ rating > 0 ? (rating * 20) : 0 }}%</div> 
                            <small>Olumlu Puan</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Profile Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-custom-light border-bottom">
    <div class="container">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab === 'activity'" (click)="setActiveTab('activity')">Aktivite</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab === 'settings'" (click)="setActiveTab('settings')">Ayarlar</a>
            </li>
        </ul>
        <div> <!-- Sağ taraf (Çıkış Yap Butonu) -->
                        <button class="btn btn-danger btn-sm" (click)="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Çıkış Yap
                        </button>
                    </div>
    </div>
</nav>

<!-- Profile Content -->

<main class="container my-5">
    <!-- Tab content -->
    <div class="tab-content">
        <div class="tab-pane fade" [class.show]="activeTab === 'activity'" [class.active]="activeTab === 'activity'">
            <h4 class="mb-4">Aktivite Geçmişi</h4>
            
            <!-- Devam Eden İşler -->
             <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-truck-loading me-2"></i>Devam Eden Teslimatlarım</h5>
            
            <div *ngIf="isLoadingAcceptedParcels" class="text-center my-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Teslimatlarınız yükleniyor...</span>
                </div>
                <p class="mt-2">Teslimatlarınız yükleniyor...</p>
            </div>
        
            <div *ngIf="acceptedParcelsError && !isLoadingAcceptedParcels" class="alert alert-danger my-3">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ acceptedParcelsError }}
            </div>
        
            <div *ngIf="!isLoadingAcceptedParcels && !acceptedParcelsError && myAcceptedParcels.length === 0" class="alert alert-info my-3">
                <i class="fas fa-info-circle me-2"></i>Şu anda devam eden bir teslimatınız bulunmamaktadır.
                <p class="mt-2 mb-0">Yeni teslimat görevleri almak için <a routerLink="/">ana sayfadaki</a> açık kargo taleplerine göz atabilirsiniz.</p>
            </div>
        
            <div *ngIf="!isLoadingAcceptedParcels && !acceptedParcelsError && myAcceptedParcels.length > 0">
                <div class="list-group">
                    <div *ngFor="let parcel of myAcceptedParcels" class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm rounded">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold text-primary">{{ parcel.cargoDescription || 'Açıklama Yok' }}</h6>
                            <small>Durum: <span class="badge bg-warning text-dark">{{ parcel.status }}</span></small>
                        </div>
                        <p class="mb-1">
                            <i class="fas fa-map-marker-alt text-danger me-1"></i><strong>Alım:</strong> {{ parcel.cargoPickupLocation || 'Belirtilmemiş' }} <br>
                            <i class="fas fa-map-pin text-success me-1"></i><strong>Teslimat:</strong> {{ parcel.cargoDeliveryLocation || 'Belirtilmemiş' }}
                        </p>
                        <p class="mb-1" *ngIf="parcel.senderName">
                            <i class="fas fa-user me-1"></i><strong>Gönderen:</strong> {{ parcel.senderName }}
                             <span *ngIf="parcel.senderContactInfo">({{ parcel.senderContactInfo }})</span>
                        </p>
                         <p class="mb-1" *ngIf="parcel.receiverName">
                            <i class="fas fa-user-tag me-1"></i><strong>Alıcı:</strong> {{ parcel.receiverName }}
                             <span *ngIf="parcel.receiverContactInfo">({{ parcel.receiverContactInfo }})</span>
                        </p>
                        <p class="mb-1" *ngIf="parcel.paymentProposedFee != null">
                            <i class="fas fa-coins me-1"></i><strong>Taşıma Ücreti:</strong> {{ parcel.paymentProposedFee | currency:'TRY':'symbol' }}
                        </p>
                        <small class="text-muted" *ngIf="parcel.createdAt"><i class="far fa-calendar-alt me-1"></i>Talep Tarihi: {{ parcel.createdAt | date:'dd/MM/yyyy HH:mm' }}</small>
                        
                        <div class="mt-3 d-flex justify-content-end">
                            <button class="btn btn-sm btn-success" (click)="markAsDelivered(parcel.id)">
                                <i class="fas fa-check-double me-1"></i> Teslim Ettim
                            </button>
                            <!-- <button class="btn btn-sm btn-outline-info me-2">Detayları Gör</button> -->
                        </div>
                    </div>
                </div>
            </div>
            <hr class="my-4"> <!-- Dinamik listenin altına bir ayırıcı -->
            
            <!-- Tamamlanan İşler (Dinamik Hale Getirildi) -->
            <h5 class="border-bottom pb-2 mt-5"><i class="fas fa-check-circle me-2"></i>Tamamlanan İşlerim</h5>

            <div *ngIf="isLoadingCompletedParcels" class="text-center my-3">
                <div class="spinner-border text-success" role="status"> <!-- Renk değişti -->
                    <span class="visually-hidden">Tamamlanan işleriniz yükleniyor...</span>
                </div>
                <p class="mt-2">Tamamlanan işleriniz yükleniyor...</p>
            </div>

            <div *ngIf="completedParcelsError && !isLoadingCompletedParcels" class="alert alert-danger my-3">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ completedParcelsError }}
            </div>

            <div *ngIf="!isLoadingCompletedParcels && !completedParcelsError && myCompletedParcels.length === 0" class="alert alert-secondary my-3"> <!-- Renk değişti -->
                <i class="fas fa-history me-2"></i>Henüz tamamlanmış bir teslimatınız bulunmamaktadır.
            </div>

            <div *ngIf="!isLoadingCompletedParcels && !completedParcelsError && myCompletedParcels.length > 0">
                <div class="list-group">
                    <div *ngFor="let parcel of myCompletedParcels" class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm rounded border-success"> <!-- Kenarlık eklendi -->
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold text-success">{{ parcel.cargoDescription || 'Açıklama Yok' }}</h6> <!-- Renk değişti -->
                            <small>Durum: 
                                <span class="badge" [ngClass]="{
                                    'bg-success text-white': parcel.status === 'Delivered', 
                                    'bg-danger text-white': parcel.status === 'Cancelled', 
                                    'bg-secondary text-white': parcel.status !== 'Delivered' && parcel.status !== 'Cancelled'
                                }">
                                    {{ parcel.status === 'Delivered' ? 'Teslim Edildi' : (parcel.status === 'Cancelled' ? 'İptal Edildi' : parcel.status) }}
                                </span>
                            </small>
                        </div>
                        <p class="mb-1">
                            <i class="fas fa-map-marker-alt text-danger me-1"></i><strong>Alım:</strong> {{ parcel.cargoPickupLocation || 'Belirtilmemiş' }} <br>
                            <i class="fas fa-map-pin text-success me-1"></i><strong>Teslimat:</strong> {{ parcel.cargoDeliveryLocation || 'Belirtilmemiş' }}
                        </p>
                         <p class="mb-1" *ngIf="parcel.senderName">
                            <i class="fas fa-user me-1"></i><strong>Gönderen:</strong> {{ parcel.senderName }}
                             <span *ngIf="parcel.senderContactInfo">({{ parcel.senderContactInfo }})</span>
                        </p>
                         <p class="mb-1" *ngIf="parcel.receiverName">
                            <i class="fas fa-user-tag me-1"></i><strong>Alıcı:</strong> {{ parcel.receiverName }}
                             <span *ngIf="parcel.receiverContactInfo">({{ parcel.receiverContactInfo }})</span>
                        </p>
                        <p class="mb-1" *ngIf="parcel.paymentProposedFee != null">
                            <i class="fas fa-coins me-1"></i><strong>Alınan Ücret:</strong> {{ parcel.paymentProposedFee | currency:'TRY':'symbol' }}
                        </p>
                        <small class="text-muted" *ngIf="parcel.updatedAt">
                            <i class="far fa-calendar-check me-1"></i>
                            {{ parcel.status === 'Delivered' ? 'Teslim Tarihi' : (parcel.status === 'Cancelled' ? 'İptal Tarihi' : 'Son Güncelleme') }}: 
                            {{ parcel.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                        </small>
                         <small class="text-muted d-block" *ngIf="parcel.createdAt && (!parcel.updatedAt || (parcel.status !== 'Delivered' && parcel.status !== 'Cancelled'))">
                            <i class="far fa-calendar-alt me-1"></i>Talep Tarihi: {{ parcel.createdAt | date:'dd/MM/yyyy HH:mm' }}
                        </small>
                    </div>
                </div>
            </div>
            <hr class="my-4"> <!-- "Tamamlanan İşlerim"den sonra bir ayırıcı -->
            
            <!-- YENİ BÖLÜM: Gönderdiğim Kargolarım (Gönderici olarak) - AKTİVİTE SEKMESİNİN İÇİNE TAŞINDI -->
            <h5 class="border-bottom pb-2 mt-5"><i class="fas fa-paper-plane me-2"></i>Gönderdiğim Kargolarım</h5>

            <div *ngIf="isLoadingSentParcels" class="text-center my-3">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Gönderdiğiniz kargolar yükleniyor...</span>
                </div>
                <p class="mt-2">Gönderdiğiniz kargolar yükleniyor...</p>
            </div>

            <div *ngIf="sentParcelsError && !isLoadingSentParcels" class="alert alert-danger my-3">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ sentParcelsError }}
            </div>

            <div *ngIf="!isLoadingSentParcels && !sentParcelsError && mySentParcels.length === 0" class="alert alert-info my-3">
                <i class="fas fa-info-circle me-2"></i>Henüz gönderdiğiniz bir kargo bulunmamaktadır.
                 <p class="mt-2 mb-0">Yeni bir kargo talebi oluşturmak için <a routerLink="/cargo-request-create">buraya tıklayın</a>.</p>
            </div>

            <div *ngIf="!isLoadingSentParcels && !sentParcelsError && mySentParcels.length > 0">
                <div class="list-group">
                    <div *ngFor="let parcel of mySentParcels" class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm rounded">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold text-info">{{ parcel.cargoDescription || 'Açıklama Yok' }}</h6>
                            <small>Durum:
                                <span class="badge" [ngClass]="{
                                    'bg-success text-white': parcel.status === 'Delivered',
                                    'bg-danger text-white': parcel.status === 'Cancelled',
                                    'bg-warning text-dark': parcel.status === 'Accepted' || parcel.status === 'PendingCarrier',
                                    'bg-primary text-white': parcel.status === 'InTransit',
                                    'bg-info text-white': parcel.status === 'Pending',
                                    'bg-secondary text-white': !['Delivered', 'Cancelled', 'Accepted', 'PendingCarrier', 'InTransit', 'Pending'].includes(parcel.status)
                                }">
                                    {{ getStatusDisplayName(parcel.status) }}
                                </span>
                            </small>
                        </div>
                        <p class="mb-1">
                            <i class="fas fa-map-marker-alt text-danger me-1"></i><strong>Alım:</strong> {{ parcel.cargoPickupLocation || 'Belirtilmemiş' }} <br>
                            <i class="fas fa-map-pin text-success me-1"></i><strong>Teslimat:</strong> {{ parcel.cargoDeliveryLocation || 'Belirtilmemiş' }}
                        </p>
                        <p class="mb-1" *ngIf="parcel.receiverName">
                            <i class="fas fa-user-tag me-1"></i><strong>Alıcı:</strong> {{ parcel.receiverName }}
                             <span *ngIf="parcel.receiverContactInfo">({{ parcel.receiverContactInfo }})</span>
                        </p>
                        <p class="mb-1" *ngIf="parcel.carrierUser?.userName">
                            <i class="fas fa-truck me-1"></i><strong>Taşıyıcı:</strong> {{ parcel.carrierUser.userName }}
                            <span *ngIf="parcel.carrierUser?.phoneNumber"> ({{ parcel.carrierUser.phoneNumber }})</span>
                        </p>
                        <p class="mb-1" *ngIf="parcel.paymentProposedFee != null">
                            <i class="fas fa-coins me-1"></i><strong>Teklif Edilen Ücret:</strong> {{ parcel.paymentProposedFee | currency:'TRY':'symbol' }}
                        </p>
                        <small class="text-muted" *ngIf="parcel.createdAt"><i class="far fa-calendar-alt me-1"></i>Talep Tarihi: {{ parcel.createdAt | date:'dd/MM/yyyy HH:mm' }}</small>
                        <small class="text-muted d-block" *ngIf="parcel.updatedAt && parcel.createdAt !== parcel.updatedAt"><i class="far fa-calendar-check me-1"></i>Son Güncelleme: {{ parcel.updatedAt | date:'dd/MM/yyyy HH:mm' }}</small>
                        
                        <div *ngIf="(parcel.status === 'Pending' || parcel.status === 'PendingCarrier') && !parcel.carrierUserId" class="mt-3 d-flex justify-content-end">
                            <!-- parcel.carrierUserId backend modelinize göre değişebilir (örn: parcel.carrierId, parcel.carrierUser?.id vb.) -->
                            <button class="btn btn-sm btn-outline-danger" (click)="cancelMySentParcel(parcel.id)" [disabled]="isLoadingSentParcels">
                                <i class="fas fa-times-circle me-1"></i> Talebi İptal Et
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div> <!-- Aktivite Sekmesi Bitişi -->
        
        <!-- Ayarlar Sekmesi Başlangıcı -->
        <div class="tab-pane fade" [class.show]="activeTab === 'settings'" [class.active]="activeTab === 'settings'">
            <h4 class="mb-4">Profil Ayarları</h4>
            
            <form #settingsForm="ngForm" (ngSubmit)="saveProfileSettings()">
                <!-- Kişisel Bilgiler -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Kişisel Bilgiler</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="firstName" class="form-label">Ad</label>
                            <input type="text" class="form-control" id="firstName" value="Ahmet" [(ngModel)]="firstName" name="firstName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="lastName" class="form-label">Soyad</label>
                            <input type="text" class="form-control" id="lastName" value="Yılmaz" [(ngModel)]="lastName" name="lastName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">E-posta Adresi</label>
                            <input type="email" class="form-control" id="email" value="ahmet.yilmaz@example.com" [(ngModel)]="email" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon Numarası</label>
                            <input type="tel" class="form-control" id="phone" value="05XX XXX XX XX" [(ngModel)]="phoneNumber" name="phone" required>
                        </div>
                        
                        
                    </div>
                </div>
                
                <!-- Şifre Değiştirme -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Şifre Değiştir</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Mevcut Şifre</label>
                            <input type="password" class="form-control" id="currentPassword">
                        </div>
                        
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Yeni Şifre</label>
                            <input type="password" class="form-control" id="newPassword">
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Şifre Tekrar</label>
                            <input type="password" class="form-control" id="confirmPassword">
                        </div>
                    </div>
                </div>
                
                <!-- Ödeme Bilgileri -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Ödeme Bilgileri</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="bankAccount" class="form-label">Banka Hesap Numarası</label>
                            <input type="text" class="form-control" id="bankAccount" value="TR XX XXXX XXXX XXXX XXXX XX">
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankName" class="form-label">Banka Adı</label>
                            <input type="text" class="form-control" id="bankName" value="XBank">
                        </div>
                    </div>
                </div>
                
                <!-- Bildirim Ayarları -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Bildirim Ayarları</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="emailNotif" checked>
                            <label class="form-check-label" for="emailNotif">E-posta Bildirimleri</label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="smsNotif" checked>
                            <label class="form-check-label" for="smsNotif">SMS Bildirimleri</label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="newOrder">
                            <label class="form-check-label" for="newOrder">Yeni Kargo İş İlanları</label>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-light me-md-2">İptal</button>
                    <button type="submit" class="btn btn-warning" (click)="saveProfileSettings()">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div> <!-- tab-content kapanışı -->
</main>

<!-- Footer -->
<footer class="bg-custom-primary text-light py-4">
    <div class="container text-center">
        <p class="mb-0">&copy; 2023 ÖğrenciKargo. Tüm hakları saklıdır.</p>
    </div>
</footer>

<!-- Bootstrap JS -->
</body>
</html>